{"version":3,"file":"router.js","sources":["../../src/router.ts"],"sourcesContent":["import { WINDOW, captureException } from '@sentry/browser';\nimport { SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, spanToJSON } from '@sentry/core';\nimport type { SpanAttributes, Transaction, TransactionContext, TransactionSource } from '@sentry/types';\n\nimport { getActiveTransaction } from './tracing';\n\ninterface VueRouterInstrumationOptions {\n  /**\n   * What to use for route labels.\n   * By default, we use route.name (if set) and else the path.\n   *\n   * Default: 'name'\n   */\n  routeLabel: 'name' | 'path';\n}\n\nexport type VueRouterInstrumentation = <T extends Transaction>(\n  startTransaction: (context: TransactionContext) => T | undefined,\n  startTransactionOnPageLoad?: boolean,\n  startTransactionOnLocationChange?: boolean,\n) => void;\n\n// The following type is an intersection of the Route type from VueRouter v2, v3, and v4.\n// This is not great, but kinda necessary to make it work with all versions at the same time.\nexport type Route = {\n  /** Unparameterized URL */\n  path: string;\n  /**\n   * Query params (keys map to null when there is no value associated, e.g. \"?foo\" and to an array when there are\n   * multiple query params that have the same key, e.g. \"?foo&foo=bar\")\n   */\n  query: Record<string, string | null | (string | null)[]>;\n  /** Route name (VueRouter provides a way to give routes individual names) */\n  name?: string | symbol | null | undefined;\n  /** Evaluated parameters */\n  params: Record<string, string | string[]>;\n  /** All the matched route objects as defined in VueRouter constructor */\n  matched: { path: string }[];\n};\n\ninterface VueRouter {\n  onError: (fn: (err: Error) => void) => void;\n  beforeEach: (fn: (to: Route, from: Route, next?: () => void) => void) => void;\n}\n\n/**\n * Creates routing instrumentation for Vue Router v2, v3 and v4\n *\n * You can optionally pass in an options object with the available option:\n * * `routeLabel`: Set this to `route` to opt-out of using `route.name` for transaction names.\n *\n * @param router The Vue Router instance that is used\n *\n * @deprecated Use `browserTracingIntegration()` from `@sentry/vue` instead - this includes the vue router instrumentation.\n */\nexport function vueRouterInstrumentation(\n  router: VueRouter,\n  options: Partial<VueRouterInstrumationOptions> = {},\n): VueRouterInstrumentation {\n  return (\n    startTransaction: (context: TransactionContext) => Transaction | undefined,\n    startTransactionOnPageLoad: boolean = true,\n    startTransactionOnLocationChange: boolean = true,\n  ) => {\n    // We have to start the pageload transaction as early as possible (before the router's `beforeEach` hook\n    // is called) to not miss child spans of the pageload.\n    // We check that window & window.location exists in order to not run this code in SSR environments.\n    if (startTransactionOnPageLoad && WINDOW && WINDOW.location) {\n      startTransaction({\n        name: WINDOW.location.pathname,\n        op: 'pageload',\n        attributes: {\n          [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.vue',\n          [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n        },\n      });\n    }\n\n    instrumentVueRouter(\n      router,\n      {\n        routeLabel: options.routeLabel || 'name',\n        instrumentNavigation: startTransactionOnLocationChange,\n        instrumentPageLoad: startTransactionOnPageLoad,\n      },\n      startTransaction,\n    );\n  };\n}\n\n/**\n * Instrument the Vue router to create navigation spans.\n */\nexport function instrumentVueRouter(\n  router: VueRouter,\n  options: {\n    routeLabel: 'name' | 'path';\n    instrumentPageLoad: boolean;\n    instrumentNavigation: boolean;\n  },\n  startNavigationSpanFn: (context: TransactionContext) => void,\n): void {\n  router.onError(error => captureException(error, { mechanism: { handled: false } }));\n\n  router.beforeEach((to, from, next) => {\n    // According to docs we could use `from === VueRouter.START_LOCATION` but I couldnt get it working for Vue 2\n    // https://router.vuejs.org/api/#router-start-location\n    // https://next.router.vuejs.org/api/#start-location\n\n    // from.name:\n    // - Vue 2: null\n    // - Vue 3: undefined\n    // hence only '==' instead of '===', because `undefined == null` evaluates to `true`\n    const isPageLoadNavigation = from.name == null && from.matched.length === 0;\n\n    const attributes: SpanAttributes = {\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.vue',\n    };\n\n    for (const key of Object.keys(to.params)) {\n      attributes[`params.${key}`] = to.params[key];\n    }\n    for (const key of Object.keys(to.query)) {\n      const value = to.query[key];\n      if (value) {\n        attributes[`query.${key}`] = value;\n      }\n    }\n\n    // Determine a name for the routing transaction and where that name came from\n    let transactionName: string = to.path;\n    let transactionSource: TransactionSource = 'url';\n    if (to.name && options.routeLabel !== 'path') {\n      transactionName = to.name.toString();\n      transactionSource = 'custom';\n    } else if (to.matched[0] && to.matched[0].path) {\n      transactionName = to.matched[0].path;\n      transactionSource = 'route';\n    }\n\n    if (options.instrumentPageLoad && isPageLoadNavigation) {\n      // eslint-disable-next-line deprecation/deprecation\n      const pageloadTransaction = getActiveTransaction();\n      if (pageloadTransaction) {\n        const existingAttributes = spanToJSON(pageloadTransaction).data || {};\n        if (existingAttributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] !== 'custom') {\n          pageloadTransaction.updateName(transactionName);\n          pageloadTransaction.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, transactionSource);\n        }\n        // Set router attributes on the existing pageload transaction\n        // This will  the origin, and add params & query attributes\n        pageloadTransaction.setAttributes({\n          ...attributes,\n          [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.vue',\n        });\n      }\n    }\n\n    if (options.instrumentNavigation && !isPageLoadNavigation) {\n      attributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] = transactionSource;\n      startNavigationSpanFn({\n        name: transactionName,\n        op: 'navigation',\n        attributes,\n      });\n    }\n\n    // Vue Router 4 no longer exposes the `next` function, so we need to\n    // check if it's available before calling it.\n    // `next` needs to be called in Vue Router 3 so that the hook is resolved.\n    if (next) {\n      next();\n    }\n  });\n}\n"],"names":[],"mappings":"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"}